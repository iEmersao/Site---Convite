<script type="module">
  // ----- Importando Firebase -----
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { 
    getFirestore, collection, addDoc, onSnapshot, serverTimestamp 
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // ----- ConfiguraÃ§Ã£o do Firebase -----
  const firebaseConfig = {
    apiKey: "AIzaSyAHP64jj8-5saOazBuRI1BH43DnV4QsljQ",
    authDomain: "churras-rafa.firebaseapp.com",
    projectId: "churras-rafa",
    storageBucket: "churras-rafa.firebasestorage.app",
    messagingSenderId: "311070733036",
    appId: "1:311070733036:web:a5743ee2011ccf1d342bc9",
    measurementId: "G-3C3WJVFYMX"
  };

  // ----- Inicializando -----
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ----- ReferÃªncia da coleÃ§Ã£o -----
  const presencasRef = collection(db, "presencas");

  // ----- Renderizar cards -----
  function criarCard(item) {
    const card = document.createElement("div");
    card.className = "card item";

    const nomeEl = document.createElement("strong");
    nomeEl.textContent = item.nome;

    const presencaEl = document.createElement("em");
    presencaEl.textContent = ` â€” ${item.presenca}`;

    const recadoEl = document.createElement("p");
    recadoEl.textContent = item.recado || "";

    card.appendChild(nomeEl);
    card.appendChild(presencaEl);
    card.appendChild(document.createElement("br"));
    card.appendChild(recadoEl);

    return card;
  }

  // ----- Carregar em tempo real -----
  const lista = document.getElementById("lista");
  const contador = document.getElementById("contador");

  onSnapshot(presencasRef, (snapshot) => {
    lista.innerHTML = "";
    contador.innerText = snapshot.size;

    snapshot.forEach((doc) => {
      lista.appendChild(criarCard(doc.data()));
    });
  });

  // ----- Confirmar presenÃ§a -----
  async function confirmar() {
    const nome = document.getElementById("nome").value.trim();
    const presenca = document.getElementById("presenca").value;
    const recado = document.getElementById("recado").value.trim();
    const emojis = ["ğŸ–", "ğŸº", "ğŸ¶", "ğŸ”¥", "ğŸ˜„", "ğŸ¥©", "ğŸ‰"];

    if (!nome) {
      alert("Coloca seu nome aÃ­, pÃ´! ğŸ˜„");
      return;
    }

    try {
      await addDoc(presencasRef, {
        nome,
        presenca,
        recado,
        timestamp: serverTimestamp()
      });

      document.getElementById("nome").value = "";
      document.getElementById("recado").value = "";

      alert(`ğŸ‰ PresenÃ§a confirmada! Valeu por avisar ${emojis[Math.floor(Math.random()*emojis.length)]}`);
    } catch (erro) {
      console.error("Erro ao salvar:", erro);
      alert("Ocorreu um erro ao confirmar.");
    }
  }

  // ----- Contagem regressiva -----
  function atualizarContagemRegressiva() {
    const evento = new Date("2025-12-13T19:00:00");
    const agora = new Date();
    const diff = evento - agora;

    const el = document.getElementById("countdown");

    if (diff <= 0) {
      el.innerText = "ğŸ‰ JÃ¡ comeÃ§ou!";
      return;
    }

    const dias = Math.floor(diff / (1000 * 60 * 60 * 24));
    const horas = Math.floor((diff / (1000 * 60 * 60)) % 24);
    const minutos = Math.floor((diff / (1000 * 60)) % 60);
    const segundos = Math.floor((diff / 1000) % 60);

    el.innerText = `â³ Faltam ${dias}d ${horas}h ${minutos}m ${segundos}s`;
  }

  // ----- MÃºsica -----
  function playMusica() {
    const musica = document.getElementById("musica");

    function tentar() {
      try {
        if (typeof musica.duration === "number" && musica.duration > 0) {
          musica.currentTime = Math.min(30, musica.duration);
        } else {
          musica.currentTime = 0;
        }
      } catch {}

      musica.play().catch(() => {
        alert("Seu navegador bloqueou o Ã¡udio. Tente clicar de novo.");
      });
    }

    if (!isFinite(musica.duration) || musica.duration === 0) {
      musica.addEventListener("loadedmetadata", tentar, { once: true });
    } else {
      tentar();
    }
  }

  // ----- Eventos -----
  document.getElementById("confirm-btn").addEventListener("click", confirmar);
  document.getElementById("play-music-btn").addEventListener("click", playMusica);

  atualizarContagemRegressiva();
  setInterval(atualizarContagemRegressiva, 1000);
</script>
